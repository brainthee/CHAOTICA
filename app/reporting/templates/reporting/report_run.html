{% extends "reporting/base.html" %}
{% load static %}

{% block title %}Run Report: {{ report.name }}{% endblock %}

{% block report_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Run Report: {{ report.name }}</h2>
    <a href="{% url 'reporting:report_detail' pk=report.id %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Report Details
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h5>Run Options</h5>
    </div>
    <div class="card-body">
        <form method="post" id="run-report-form">
            {% csrf_token %}
            
            {% if has_prompts %}
            <div class="filter-prompts mb-4">
                <h5>Filter Prompts</h5>
                <p class="text-muted">Please provide values for the following filter prompts:</p>
                
                {% for prompt in filter_prompts %}
                <div class="mb-3">
                    <label for="prompt_{{ prompt.id }}" class="form-label">{{ prompt.prompt }}</label>
                    
                    {% if prompt.field_type == 'date' %}
                    <input type="date" class="form-control" id="prompt_{{ prompt.id }}" name="prompt_{{ prompt.id }}">
                    
                    {% elif prompt.field_type == 'datetime' %}
                    <input type="datetime-local" class="form-control" id="prompt_{{ prompt.id }}" name="prompt_{{ prompt.id }}">
                    
                    {% elif prompt.field_type == 'boolean' %}
                    <select class="form-select" id="prompt_{{ prompt.id }}" name="prompt_{{ prompt.id }}">
                        <option value="">-- Select --</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                    
                    {% elif prompt.field_type == 'number' %}
                    <input type="number" class="form-control" id="prompt_{{ prompt.id }}" name="prompt_{{ prompt.id }}">
                    
                    {% else %}
                    <input type="text" class="form-control" id="prompt_{{ prompt.id }}" name="prompt_{{ prompt.id }}">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if report.allow_runtime_presentation_choice %}
            <div class="format-selection mb-4">
                <h5>Output Format</h5>
                <p class="text-muted">Select the desired output format for the report:</p>
                
                <div class="d-flex flex-wrap gap-3">
                    {% for format_code, format_name in presentation_choices %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="format" id="format_{{ format_code }}" 
                               value="{{ format_code }}" {% if format_code == report.default_presentation %}checked{% endif %}>
                        <label class="form-check-label" for="format_{{ format_code }}">
                            {{ format_name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-primary" id="preview-report-btn">
                    <i class="fas fa-eye"></i> Preview Report
                </button>
                
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-play"></i> Run Report
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Preview: {{ report.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-5" id="preview-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Generating preview...</p>
                </div>
                
                <div id="preview-content" style="display: none;">
                    <!-- Preview content will be loaded here -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> This is a preview showing up to 10 records. The full report may contain more data.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="preview-table">
                            <thead>
                                <tr>
                                    <!-- Column headers will be inserted here -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="alert alert-danger" id="preview-error" style="display: none;">
                    An error occurred while generating the preview. Please try again.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-success" form="run-report-form">
                    <i class="fas fa-play"></i> Run Full Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_javascript_page %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Handle preview button click
    $('#preview-report-btn').click(function() {
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        previewModal.show();
        
        // Reset modal state
        $('#preview-loading').show();
        $('#preview-content').hide();
        $('#preview-error').hide();
        
        // Collect form data
        const formData = new FormData($('#run-report-form')[0]);
        
        // Send AJAX request for preview
        $.ajax({
            url: '{% url "reporting:report_preview" pk=report.id %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // Hide loading indicator
                $('#preview-loading').hide();
                
                if (response.error) {
                    // Show error message
                    $('#preview-error').text(response.error).show();
                } else {
                    // Build preview table
                    buildPreviewTable(response);
                    
                    // Show preview content
                    $('#preview-content').show();
                }
            },
            error: function() {
                // Hide loading indicator
                $('#preview-loading').hide();
                
                // Show error message
                $('#preview-error').show();
            }
        });
    });
    
    function buildPreviewTable(data) {
        // Clear existing table content
        const tableHead = $('#preview-table thead tr');
        const tableBody = $('#preview-table tbody');
        tableHead.empty();
        tableBody.empty();
        
        // Exit if no data
        if (!data.data || data.data.length === 0) {
            tableBody.append('<tr><td colspan="100%" class="text-center py-4">No data to display</td></tr>');
            return;
        }
        
        // Add column headers
        const columns = Object.keys(data.data[0]);
        columns.forEach(column => {
            tableHead.append(`<th>${column.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase())}</th>`);
        });
        
        // Add data rows
        data.data.forEach(row => {
            const tr = $('<tr>');
            
            columns.forEach(column => {
                let cellValue = row[column] ?? '';
                
                // Format dates if applicable
                if (typeof cellValue === 'string' && cellValue.match(/^\d{4}-\d{2}-\d{2}T/)) {
                    cellValue = new Date(cellValue).toLocaleString();
                }
                
                tr.append(`<td>${cellValue}</td>`);
            });
            
            tableBody.append(tr);
        });
    }
});
</script>
{% endblock %}