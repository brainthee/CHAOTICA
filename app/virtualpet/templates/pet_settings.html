{% load static %}
{% load crispy_forms_tags %}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Virtual Pet Settings</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {{ form|crispy }}
                        
                        <div class="mt-4">
                            <h5>Preview</h5>
                            <div id="pet-preview" class="border rounded p-4 text-center" style="height: 200px; position: relative;">
                                <!-- Preview will be rendered here -->
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import VirtualPet from "{% static 'virtualpet/virtual-pet.js' %}";
    
    document.addEventListener('DOMContentLoaded', function() {
        const previewContainer = document.getElementById('pet-preview');
        let petInstance = null;
        
        // Function to update preview based on form values
        function updatePreview() {
            // Remove previous instance if exists
            if (petInstance) {
                petInstance.container.remove();
            }
            
            // Get current form values
            const petName = document.getElementById('id_pet_name').value || 'Bitsy';
            const petPosition = document.getElementById('id_pet_position').value || 'bottom-right';
            const petSize = document.getElementById('id_pet_size').value || 'medium';
            
            // Create new pet instance
            petInstance = new VirtualPet({
                container: previewContainer,
                petName: petName,
                position: 'bottom-right', // Always center in preview
                size: petSize
            });
            
            // Center the pet in the preview container
            petInstance.container.style.position = 'absolute';
            petInstance.container.style.left = '50%';
            petInstance.container.style.top = '50%';
            petInstance.container.style.transform = 'translate(-50%, -50%)';
        }
        
        // Initial preview
        updatePreview();
        
        // Update preview when form values change
        document.getElementById('id_pet_name').addEventListener('input', updatePreview);
        document.getElementById('id_pet_position').addEventListener('change', updatePreview);
        document.getElementById('id_pet_size').addEventListener('change', updatePreview);
    });
</script>