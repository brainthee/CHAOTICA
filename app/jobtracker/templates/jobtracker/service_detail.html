{% extends 'base.html' %}
{% load menu %}
{% load index %}
{% load static %}

{% block pageTitle %}
  {{ service }}
{% endblock %}
{% block head_title %}
  {{ service }}
{% endblock %}

{% block breadcrumbItem %}
  <li class="breadcrumb-item text-sm">
    <a class="opacity-50 text-body-emphasis" href="{% url 'service_list' %}">Services</a>
  </li>
  <li class="breadcrumb-item text-sm text-body-emphasis active" aria-current="page">{{ service.name }}</li>
{% endblock %}

{% block content_classes %}
  pt-15 px-0
{% endblock %}
{% block breadcrumb_classes %}
  px-5
{% endblock %}

{% block content %}
  <div class="row px-5">
    <div class="col-12">
      <div class="row align-items-center justify-content-between g-3 mt-0 mb-0">
        <div class="col-6 col-md-auto">
          <h2 class="mb-2">Service Detail</h2>
        </div>

        <div class="col-md-auto">
          <div class="d-flex">
            <a href="{% url 'service_update' service.slug %}" class="btn btn-outline-secondary ms-auto">Edit</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-between ms-3 me-3 g-3 mt-0 mb-0">
    <div class="col-4 g-3">
      <div class="card">
        <div class="card-body">
          <div class="row align-items-center g-3">
            <div class="col-12 col-sm-auto flex-1">
              <h3 class="fw-bolder mb-2 line-clamp-1">{{ service.name }}</h3>

              <table class="w-100 table-stats table-stats">
                <caption>Service Info</caption>
                <tbody>
                  <tr class="d-flex">
                    <th class="col-3" scope="col"></th>
                    <th class="col-1" scope="col"></th>
                    <th class="col" scope="col"></th>
                  </tr>
                  <tr>
                    <td class="py-2">
                      <div class="d-flex align-items-center">
                        <p class="fw-bold mb-0">Link</p>
                      </div>
                    </td>
                    <td class="py-2 d-none d-sm-block pe-sm-2">:</td>
                    <td class="py-2">
                      {% if service.link %}
                        <a class="text-break" href="{{ service.link }}">{{ service.link }}</a>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td class="py-2">
                      <div class="d-flex align-items-center">
                        <p class="fw-bold mb-0">Owners</p>
                      </div>
                    </td>
                    <td class="py-2 d-none d-sm-block pe-sm-2">:</td>
                    <td class="py-2">
                      <p class="ps-6 ps-sm-0 fw-semi-bold mb-0">
                        {% include 'partials/users/user_group.html' with users=service.owners.all %}
                      </p>
                    </td>
                  </tr>
                  <tr>
                    <td class="py-2">
                      <div class="d-flex align-items-center">
                        <p class="fw-bold mb-0">Required <br />Skills</p>
                      </div>
                    </td>
                    <td class="py-2 d-none d-sm-block pe-sm-2">:</td>
                    <td class="py-2">
                      <p class="ps-6 ps-sm-0 fw-semi-bold mb-0">
                        {% for skill in service.skillsRequired.all %}
                          {% include 'partials/skill/skill_badge.html' with skill=skill %}
                        {% endfor %}
                      </p>
                    </td>
                  </tr>
                  <tr>
                    <td class="py-2">
                      <div class="d-flex align-items-center">
                        <p class="fw-bold mb-0">Desired <br />Skills</p>
                      </div>
                    </td>
                    <td class="py-2 d-none d-sm-block pe-sm-2">:</td>
                    <td class="py-2">
                      <p class="ps-6 ps-sm-0 fw-semi-bold mb-0">
                        {% for skill in service.skillsDesired.all %}
                          {% include 'partials/skill/skill_badge.html' with skill=skill %}
                        {% endfor %}
                      </p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-4">
      <div class="card">
        <div class="card-body">
          <div class="row align-items-center g-3">
            <div class="col-12 col-sm-auto flex-1">
              <h3 class="fw-bolder mb-2 line-clamp-1">Description</h3>
              {% if service.description %}
                {{ service.description }}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-4">
      <div id="service-team-breakdown-chart" style="min-height:320px"></div>
    </div>
  </div>

  <div class="row g-0 mt-3 border-1 border-top bg-body-secondary h-100">
    <div class="col-12 px-6 pt-3 border-1 border-end">
      <div class="row mx-1">
        <ul class="nav nav-underline scrollbar flex-nowrap w-100 pb-1 mb-3" id="sectionNav" role="tablist" style="overflow-y: hidden;">
          <li class="nav-item text-nowrap me-2" role="presentation">
            <a class="nav-link active" id="team-tab" data-bs-toggle="tab" href="#team" role="tab" aria-controls="tab-team" aria-selected="true"><span class="fa-solid fa-users me-2 tab-icon-color"></span>Team</a>
          </li>
          <li class="nav-item text-nowrap me-2" role="presentation">
            <a class="nav-link" id="skills-coverage-tab" data-bs-toggle="tab" href="#skills-coverage" role="tab" aria-controls="tab-skills-coverage" aria-selected="false" tabindex="-1"><span class="fa-solid fa-chart-bar me-2 tab-icon-color"></span>Skills Coverage</a>
          </li>
          {% comment %} <li class="nav-item text-nowrap me-2" role="presentation">
            <a class="nav-link" id="performance-tab" data-bs-toggle="tab" href="#performance" role="tab" aria-controls="tab-performance" aria-selected="false" tabindex="-1"><span class="fa-solid fa-chart-line me-2 tab-icon-color"></span>Performance</a>
          </li> {% endcomment %}
          <li class="nav-item text-nowrap me-2" role="presentation">
            <a class="nav-link" id="engagements-tab" data-bs-toggle="tab" href="#engagements" role="tab" aria-controls="tab-engagements" aria-selected="false" tabindex="-1"><span class="fa-solid fa-clipboard me-2 tab-icon-color"></span>Jobs</a>
          </li>
        </ul>

        <div class="tab-content" id="myTabContent">
          <div class="tab-pane fade active show" id="team" role="tabpanel" aria-labelledby="team-tab">
            <!-- Team Competency Overview -->
            <div class="row mb-4">
              <div class="col-12">
                <h4 class="mb-3">Team Competency Breakdown</h4>

                <!-- Service Readiness Overview -->
                {% with breakdown=service.get_service_readiness_breakdown %}
                <div class="alert alert-outline-secondary mb-4">
                  <div class="d-flex align-items-center">
                    <span class="fas fa-info-circle me-2"></span>
                    <div>
                      <strong>Service Readiness:</strong>
                      {{ breakdown.total_capable }} user{{ breakdown.total_capable|pluralize }} can deliver this service
                      ({{ service.skillsRequired.count }} skill{{ service.skillsRequired.count|pluralize }} required)
                    </div>
                  </div>
                </div>

                <!-- Competency Summary Cards -->
                <div class="row g-3 mb-4">
                  <div class="col-md-3">
                    <div class="card border-primary">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="flex-1">
                            <h6 class="mb-2 text-primary">Full Specialists</h6>
                            <div class="dropdown">
                              <h3 class="mb-0 dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                  style="cursor: pointer;">{{ breakdown.specialists|length }}</h3>
                              {% if breakdown.specialists %}
                                <ul class="dropdown-menu">
                                  {% for user in breakdown.specialists %}
                                    <li>
                                      <a class="dropdown-item d-flex align-items-center" href="{{ user.get_absolute_url }}">
                                        <img class="avatar avatar-xs rounded-circle me-2"
                                             src="{{ user.get_avatar }}" alt="{{ user.get_full_name }}">
                                        {{ user.get_full_name }}
                                      </a>
                                    </li>
                                  {% endfor %}
                                </ul>
                              {% endif %}
                            </div>
                            <p class="fs-10 mb-0 text-muted">Expert in ALL skills</p>
                          </div>
                          <span class="fas fa-star fa-2x text-primary opacity-50"></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card border-success">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="flex-1">
                            <h6 class="mb-2 text-success">Fully Independent</h6>
                            <div class="dropdown">
                              <h3 class="mb-0 dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                  style="cursor: pointer;">{{ breakdown.independent_only|length }}</h3>
                              {% if breakdown.independent_only %}
                                <ul class="dropdown-menu">
                                  {% for user in breakdown.independent_only %}
                                    <li>
                                      <a class="dropdown-item d-flex align-items-center" href="{{ user.get_absolute_url }}">
                                        <img class="avatar avatar-xs rounded-circle me-2"
                                             src="{{ user.get_avatar }}" alt="{{ user.get_full_name }}">
                                        {{ user.get_full_name }}
                                      </a>
                                    </li>
                                  {% endfor %}
                                </ul>
                              {% endif %}
                            </div>
                            <p class="fs-10 mb-0 text-muted">Can work alone on ALL skills</p>
                          </div>
                          <span class="fas fa-user-check fa-2x text-success opacity-50"></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card border-warning">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="flex-1">
                            <h6 class="mb-2 text-warning">Need Support</h6>
                            <div class="dropdown">
                              <h3 class="mb-0 dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                  style="cursor: pointer;">{{ breakdown.support_only|length }}</h3>
                              {% if breakdown.support_only %}
                                <ul class="dropdown-menu">
                                  {% for user in breakdown.support_only %}
                                    <li>
                                      <a class="dropdown-item d-flex align-items-center" href="{{ user.get_absolute_url }}">
                                        <img class="avatar avatar-xs rounded-circle me-2"
                                             src="{{ user.get_avatar }}" alt="{{ user.get_full_name }}">
                                        {{ user.get_full_name }}
                                      </a>
                                    </li>
                                  {% endfor %}
                                </ul>
                              {% endif %}
                            </div>
                            <p class="fs-10 mb-0 text-muted">Have ALL skills but need help</p>
                          </div>
                          <span class="fas fa-user-group fa-2x text-warning opacity-50"></span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card border-danger">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="flex-1">
                            <h6 class="mb-2 text-danger">Missing Skills</h6>
                            <div class="dropdown">
                              <h3 class="mb-0 dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                  style="cursor: pointer;">{{ breakdown.missing_skills|length }}</h3>
                              {% if breakdown.missing_skills %}
                                <ul class="dropdown-menu">
                                  {% for user in breakdown.missing_skills %}
                                    <li>
                                      <a class="dropdown-item d-flex align-items-center" href="{{ user.get_absolute_url }}">
                                        <img class="avatar avatar-xs rounded-circle me-2"
                                             src="{{ user.get_avatar }}" alt="{{ user.get_full_name }}">
                                        {{ user.get_full_name }}
                                      </a>
                                    </li>
                                  {% endfor %}
                                </ul>
                              {% endif %}
                            </div>
                            <p class="fs-10 mb-0 text-muted">Don't have all required skills</p>
                          </div>
                          <span class="fas fa-user-slash fa-2x text-danger opacity-50"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Desired Skills Analysis -->
                {% if service.skillsDesired.exists %}
                  <div class="row mb-4">
                    <div class="col-12">
                      <h5 class="mb-3">Desired Skills Coverage</h5>
                      <div class="row g-3">
                        {% for skill, analysis in breakdown.desired_skills_analysis.items %}
                          <div class="col-md-4">
                            <div class="card border-info">
                              <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                  <h6 class="mb-0">{{ skill.name }}</h6>
                                  <span class="badge bg-info">{{ analysis.coverage_percentage }}%</span>
                                </div>
                                <div class="progress mb-2" style="height: 6px;">
                                  <div class="progress-bar bg-info" style="width: {{ analysis.coverage_percentage }}%;"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                  <small class="text-muted">{{ analysis.total_with_skill }}/{{ breakdown.total_capable }} capable users</small>
                                  <div>
                                    <span class="badge bg-primary-subtle text-primary">{{ analysis.specialists|length }}</span>
                                    <span class="badge bg-success-subtle text-success">{{ analysis.independent|length }}</span>
                                    <span class="badge bg-warning-subtle text-warning">{{ analysis.support_needed|length }}</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endif %}
                {% endwith %}

                <!-- Detailed Skills Breakdown -->
                <h5 class="mb-3">Skills Coverage Detail</h5>
                <div class="accordion" id="skillsAccordion">
                  {% for skill, users_data in service.get_team_by_skill.items %}
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="heading-{{ skill.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapse-{{ skill.id }}" aria-expanded="false">
                          <div class="d-flex align-items-center w-100">
                            <span class="badge bg-primary-subtle text-primary me-2">{{ skill.name }}</span>
                            <span class="ms-auto me-3">
                              <span class="badge bg-primary">{{ users_data.specialists|length }}</span>
                              <span class="badge bg-success">{{ users_data.independent|length }}</span>
                              <span class="badge bg-warning">{{ users_data.support_needed|length }}</span>
                            </span>
                          </div>
                        </button>
                      </h2>
                      <div id="collapse-{{ skill.id }}" class="accordion-collapse collapse"
                           data-bs-parent="#skillsAccordion">
                        <div class="accordion-body">
                          <div class="row">
                            <!-- Specialists Column -->
                            <div class="col-md-4">
                              <h6 class="text-primary mb-3">Specialists</h6>
                              {% for user_skill in users_data.specialists %}
                                <div class="d-flex align-items-center mb-2">
                                  <img class="avatar avatar-s rounded-circle me-2"
                                       src="{{ user_skill.user.get_avatar }}" alt="{{ user_skill.user.get_full_name }}">
                                  <div>
                                    <a href="{{ user_skill.user.get_absolute_url }}" class="text-decoration-none">
                                      {{ user_skill.user.get_full_name }}
                                    </a>
                                    {% if user_skill.note %}
                                      <small class="d-block text-muted">{{ user_skill.note }}</small>
                                    {% endif %}
                                  </div>
                                </div>
                              {% empty %}
                                <p class="text-muted fs-9">No specialists</p>
                              {% endfor %}
                            </div>

                            <!-- Independent Column -->
                            <div class="col-md-4">
                              <h6 class="text-success mb-3">Can Do Alone</h6>
                              {% for user_skill in users_data.independent %}
                                <div class="d-flex align-items-center mb-2">
                                  <img class="avatar avatar-s rounded-circle me-2"
                                       src="{{ user_skill.user.get_avatar }}" alt="{{ user_skill.user.get_full_name }}">
                                  <div>
                                    <a href="{{ user_skill.user.get_absolute_url }}" class="text-decoration-none">
                                      {{ user_skill.user.get_full_name }}
                                    </a>
                                    {% if user_skill.note %}
                                      <small class="d-block text-muted">{{ user_skill.note }}</small>
                                    {% endif %}
                                  </div>
                                </div>
                              {% empty %}
                                <p class="text-muted fs-9">No independent practitioners</p>
                              {% endfor %}
                            </div>

                            <!-- Support Needed Column -->
                            <div class="col-md-4">
                              <h6 class="text-warning mb-3">Need Support</h6>
                              {% for user_skill in users_data.support_needed %}
                                <div class="d-flex align-items-center mb-2">
                                  <img class="avatar avatar-s rounded-circle me-2"
                                       src="{{ user_skill.user.get_avatar }}" alt="{{ user_skill.user.get_full_name }}">
                                  <div>
                                    <a href="{{ user_skill.user.get_absolute_url }}" class="text-decoration-none">
                                      {{ user_skill.user.get_full_name }}
                                    </a>
                                    {% if user_skill.note %}
                                      <small class="d-block text-muted">{{ user_skill.note }}</small>
                                    {% endif %}
                                  </div>
                                </div>
                              {% empty %}
                                <p class="text-muted fs-9">No users requiring support</p>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="skills-coverage" role="tabpanel" aria-labelledby="skills-coverage-tab">
            <!-- Skills Coverage Analysis -->
            {% with coverage=service.get_skills_coverage_analysis %}
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3">Skills Coverage Analysis</h5>

                <!-- Coverage Summary -->
                <div class="row g-3 mb-4">
                  <div class="col-md-3">
                    <div class="card text-center {% if coverage.summary.coverage_health == 'Critical' %}border-danger{% elif coverage.summary.coverage_health == 'Needs Attention' %}border-warning{% else %}border-success{% endif %}">
                      <div class="card-body py-3">
                        <h4 class="mb-1 {% if coverage.summary.coverage_health == 'Critical' %}text-danger{% elif coverage.summary.coverage_health == 'Needs Attention' %}text-warning{% else %}text-success{% endif %}">
                          {{ coverage.summary.coverage_health }}
                        </h4>
                        <p class="fs-10 mb-0 text-muted">Overall Health</p>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-primary">{{ coverage.summary.avg_required_coverage }}%</h4>
                        <p class="fs-10 mb-0 text-muted">Avg Required Coverage</p>
                        <small class="text-muted d-block">{{ coverage.summary.required_skills_count }} skills</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body py-3">
                        <h4 class="mb-1 {% if coverage.summary.critical_skills_count > 0 %}text-danger{% else %}text-success{% endif %}">{{ coverage.summary.critical_skills_count }}</h4>
                        <p class="fs-10 mb-0 text-muted">Critical Skills</p>
                        <small class="text-muted d-block">&lt; 2 specialists</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-info">{{ coverage.summary.total_skilled_users }}</h4>
                        <p class="fs-10 mb-0 text-muted">Total Skilled Users</p>
                        <small class="text-muted d-block">Organization-wide</small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Required Skills Analysis -->
                <div class="row mb-4">
                  <div class="col-12">
                    <h6 class="mb-3">Required Skills Analysis</h6>
                    <div class="row g-3">
                      {% for skill, analysis in coverage.required_skills_analysis.items %}
                        <div class="col-md-6">
                          <div class="card {% if analysis.critical %}border-danger{% elif analysis.coverage_percentage < 40 %}border-warning{% else %}border-success{% endif %}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                              <h6 class="mb-0">{{ skill.name }}</h6>
                              <div>
                                {% if analysis.critical %}
                                  <span class="badge bg-danger">Critical</span>
                                {% endif %}
                                <span class="badge bg-info">{{ analysis.coverage_percentage }}%</span>
                              </div>
                            </div>
                            <div class="card-body">
                              <!-- Coverage Progress Bar -->
                              <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar {% if analysis.critical %}bg-danger{% elif analysis.coverage_percentage < 40 %}bg-warning{% else %}bg-success{% endif %}"
                                     style="width: {{ analysis.coverage_percentage }}%;"></div>
                              </div>

                              <!-- Competency Breakdown -->
                              <div class="row text-center mb-3">
                                <div class="col-4">
                                  <h6 class="mb-1 text-primary">{{ analysis.specialists }}</h6>
                                  <small class="text-muted">Specialists</small>
                                </div>
                                <div class="col-4">
                                  <h6 class="mb-1 text-success">{{ analysis.independent }}</h6>
                                  <small class="text-muted">Independent</small>
                                </div>
                                <div class="col-4">
                                  <h6 class="mb-1 text-warning">{{ analysis.support_needed }}</h6>
                                  <small class="text-muted">Need Support</small>
                                </div>
                              </div>

                              <!-- Skill Gap & Training -->
                              {% if analysis.skill_gap > 0 %}
                                <div class="alert alert-warning py-2 mb-2">
                                  <small><strong>Gap:</strong> Need {{ analysis.skill_gap }} more specialist{{ analysis.skill_gap|pluralize }}</small>
                                </div>
                              {% endif %}

                              {% if analysis.training_candidates %}
                                <div class="mb-2">
                                  <small class="text-muted d-block mb-1">Training Candidates:</small>
                                  {% for candidate in analysis.training_candidates|slice:":3" %}
                                    <span class="badge bg-secondary-subtle text-secondary me-1">{{ candidate.get_full_name }}</span>
                                  {% endfor %}
                                  {% if analysis.training_candidates|length > 3 %}
                                    <span class="badge bg-light text-muted">+{{ analysis.training_candidates|length|add:"-3" }} more</span>
                                  {% endif %}
                                </div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <!-- Desired Skills Analysis -->
                {% if coverage.desired_skills_analysis %}
                  <div class="row mb-4">
                    <div class="col-12">
                      <h6 class="mb-3">Desired Skills Analysis</h6>
                      <div class="row g-3">
                        {% for skill, analysis in coverage.desired_skills_analysis.items %}
                          <div class="col-md-4">
                            <div class="card border-info">
                              <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                  <h6 class="mb-0">{{ skill.name }}</h6>
                                  <span class="badge bg-info">{{ analysis.coverage_percentage }}%</span>
                                </div>

                                <div class="progress mb-2" style="height: 6px;">
                                  <div class="progress-bar bg-info" style="width: {{ analysis.coverage_percentage }}%;"></div>
                                </div>

                                <div class="d-flex justify-content-between">
                                  <small class="text-muted">{{ analysis.total_users }} users have this skill</small>
                                  <div>
                                    <span class="badge bg-primary-subtle text-primary">{{ analysis.specialists }}</span>
                                    <span class="badge bg-success-subtle text-success">{{ analysis.independent }}</span>
                                    <span class="badge bg-warning-subtle text-warning">{{ analysis.support_needed }}</span>
                                  </div>
                                </div>

                                {% if analysis.opportunity_score > 70 %}
                                  <div class="mt-2">
                                    <span class="badge bg-success">High Growth Opportunity</span>
                                  </div>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
            {% endwith %}
          </div>

          {% comment %} <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
            <!-- Performance Metrics Dashboard -->
            {% with metrics=service.get_performance_metrics %}
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3">Service Performance Dashboard</h5>

                <!-- Performance Overview Cards -->
                <div class="row g-3 mb-4">
                  <div class="col-md-3">
                    <div class="card text-center {% if metrics.performance_grade == 'Excellent' %}border-success{% elif metrics.performance_grade == 'Good' %}border-primary{% elif metrics.performance_grade == 'Fair' %}border-warning{% else %}border-danger{% endif %}">
                      <div class="card-body py-3">
                        <h4 class="mb-1 {% if metrics.performance_grade == 'Excellent' %}text-success{% elif metrics.performance_grade == 'Good' %}text-primary{% elif metrics.performance_grade == 'Fair' %}text-warning{% else %}text-danger{% endif %}">
                          {{ metrics.performance_grade }}
                        </h4>
                        <p class="fs-10 mb-0 text-muted">Overall Grade</p>
                        <small class="text-muted d-block">{{ metrics.quality_metrics.performance_score }}/100</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Percentage of phases delivered on or before the promised date">
                      <div class="card-body py-3">
                        <h4 class="mb-1 {% if metrics.quality_metrics.on_time_rate >= 90 %}text-success{% elif metrics.quality_metrics.on_time_rate >= 75 %}text-primary{% else %}text-warning{% endif %}">
                          {{ metrics.quality_metrics.on_time_rate }}%
                        </h4>
                        <p class="fs-10 mb-0 text-muted">On-Time Delivery</p>
                        <small class="text-muted d-block">{{ metrics.quality_metrics.total_completed }} completed phases</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Percentage of phases delivered before the promised date">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-success">{{ metrics.quality_metrics.early_rate }}%</h4>
                        <p class="fs-10 mb-0 text-muted">Early Delivery</p>
                        <small class="text-muted d-block">Ahead of schedule</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Percentage of phases delivered after the promised date">
                      <div class="card-body py-3">
                        <h4 class="mb-1 {% if metrics.quality_metrics.late_rate <= 5 %}text-success{% elif metrics.quality_metrics.late_rate <= 15 %}text-warning{% else %}text-danger{% endif %}">
                          {{ metrics.quality_metrics.late_rate }}%
                        </h4>
                        <p class="fs-10 mb-0 text-muted">Late Delivery</p>
                        <small class="text-muted d-block">Overdue phases</small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Year-over-Year Comparison -->
                <div class="row g-3 mb-4">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Year-over-Year Performance ({{ metrics.year_comparison.current_year }} vs {{ metrics.year_comparison.last_year }})</h6>
                      </div>
                      <div class="card-body">
                        <div class="row text-center">
                          <div class="col-md-4">
                            <h5 class="mb-1 {% if metrics.year_comparison.phases_change > 0 %}text-success{% elif metrics.year_comparison.phases_change < 0 %}text-danger{% else %}text-muted{% endif %}">
                              {% if metrics.year_comparison.phases_change > 0 %}+{% endif %}{{ metrics.year_comparison.phases_change }}%
                            </h5>
                            <p class="fs-10 mb-0 text-muted">Phases Delivered</p>
                            <small class="text-muted d-block">{{ metrics.year_comparison.current_year_stats.phases }} vs {{ metrics.year_comparison.last_year_stats.phases }}</small>
                          </div>

                          <div class="col-md-4">
                            <h5 class="mb-1 {% if metrics.year_comparison.on_time_change > 0 %}text-success{% elif metrics.year_comparison.on_time_change < 0 %}text-danger{% else %}text-muted{% endif %}">
                              {% if metrics.year_comparison.on_time_change > 0 %}+{% endif %}{{ metrics.year_comparison.on_time_change }}%
                            </h5>
                            <p class="fs-10 mb-0 text-muted">On-Time Rate Change</p>
                            <small class="text-muted d-block">Percentage points</small>
                          </div>

                          <div class="col-md-4">
                            <h5 class="mb-1 {% if metrics.year_comparison.hours_change > 0 %}text-warning{% elif metrics.year_comparison.hours_change < 0 %}text-success{% else %}text-muted{% endif %}">
                              {% if metrics.year_comparison.hours_change > 0 %}+{% endif %}{{ metrics.year_comparison.hours_change }}%
                            </h5>
                            <p class="fs-10 mb-0 text-muted">Hours Change</p>
                            <small class="text-muted d-block">{{ metrics.year_comparison.current_year_stats.total_hours }}h vs {{ metrics.year_comparison.last_year_stats.total_hours }}h</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Monthly Trends Chart -->
                <div class="row g-3 mb-4">
                  <div class="col-12">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Monthly Performance Trends ({{ metrics.year_comparison.current_year }})</h6>
                      </div>
                      <div class="card-body">
                        <div id="monthly-trends-chart" style="height: 300px;"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Client Performance Breakdown -->
                {% if metrics.client_metrics %}
                  <div class="row g-3 mb-4">
                    <div class="col-12">
                      <div class="card">
                        <div class="card-header">
                          <h6 class="mb-0">Top Client Performance</h6>
                        </div>
                        <div class="card-body">
                          <div class="table-responsive">
                            <table class="table table-sm">
                              <thead>
                                <tr>
                                  <th>Client</th>
                                  <th>Phases</th>
                                  <th>On-Time Rate</th>
                                  <th>Avg Hours</th>
                                  <th>Total Hours</th>
                                  <th>Performance</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for client, data in metrics.client_metrics.items %}
                                  <tr>
                                    <td>{{ client }}</td>
                                    <td>{{ data.phases }}</td>
                                    <td>
                                      <span class="badge {% if data.on_time_rate >= 90 %}bg-success{% elif data.on_time_rate >= 75 %}bg-primary{% else %}bg-warning{% endif %}">
                                        {{ data.on_time_rate }}%
                                      </span>
                                    </td>
                                    <td>{{ data.avg_hours }}h</td>
                                    <td>{{ data.total_hours }}h</td>
                                    <td>
                                      <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if data.on_time_rate >= 90 %}bg-success{% elif data.on_time_rate >= 75 %}bg-primary{% else %}bg-warning{% endif %}"
                                             style="width: {{ data.on_time_rate }}%;">
                                          {{ data.on_time_rate }}%
                                        </div>
                                      </div>
                                    </td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endif %}

                <!-- Performance Insights -->
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Key Insights</h6>
                      </div>
                      <div class="card-body">
                        <ul class="list-unstyled mb-0">
                          {% if metrics.quality_metrics.early_rate > 20 %}
                            <li class="mb-2"><span class="badge bg-success me-2">✓</span>Excellent early delivery rate ({{ metrics.quality_metrics.early_rate }}%)</li>
                          {% endif %}
                          {% if metrics.quality_metrics.on_time_rate >= 90 %}
                            <li class="mb-2"><span class="badge bg-success me-2">✓</span>Outstanding on-time performance</li>
                          {% elif metrics.quality_metrics.on_time_rate < 75 %}
                            <li class="mb-2"><span class="badge bg-warning me-2">!</span>On-time delivery needs improvement</li>
                          {% endif %}
                          {% if metrics.quality_metrics.late_rate <= 5 %}
                            <li class="mb-2"><span class="badge bg-success me-2">✓</span>Excellent delivery timeliness</li>
                          {% elif metrics.quality_metrics.late_rate > 20 %}
                            <li class="mb-2"><span class="badge bg-warning me-2">!</span>High late delivery rate</li>
                          {% endif %}
                          {% if metrics.year_comparison.phases_change > 20 %}
                            <li class="mb-2"><span class="badge bg-info me-2">↗</span>Strong growth in service demand</li>
                          {% endif %}
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Recommendations</h6>
                      </div>
                      <div class="card-body">
                        <ul class="list-unstyled mb-0">
                          {% if metrics.quality_metrics.on_time_rate < 85 %}
                            <li class="mb-2"><span class="badge bg-primary me-2">→</span>Focus on delivery timeline management</li>
                          {% endif %}
                          {% if metrics.quality_metrics.avg_delivery_hours > 50 %}
                            <li class="mb-2"><span class="badge bg-primary me-2">→</span>Review resource allocation for large phases</li>
                          {% endif %}
                          {% if metrics.year_comparison.phases_change > 50 %}
                            <li class="mb-2"><span class="badge bg-primary me-2">→</span>Consider team capacity expansion</li>
                          {% endif %}
                          {% if metrics.quality_metrics.late_rate > 20 %}
                            <li class="mb-2"><span class="badge bg-primary me-2">→</span>Implement early warning systems</li>
                          {% endif %}
                          <li class="mb-2"><span class="badge bg-primary me-2">→</span>Continue monitoring monthly trends</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endwith %}
          </div> {% endcomment %}

          <div class="tab-pane fade" id="engagements" role="tabpanel" aria-labelledby="engagements-tab">
            <!-- Service Usage Analytics -->
            {% with analytics=service.get_service_usage_analytics %}
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-3">Service Usage Overview</h5>

                <!-- Key Metrics Cards -->
                <div class="row g-3 mb-4">
                  <div class="col-md-3">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Total number of phases using this service across all time">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-primary">{{ analytics.total_phases }}</h4>
                        <p class="fs-10 mb-0 text-muted">Total Phases</p>
                        <small class="text-muted d-block">All time</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-2">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Phases currently in progress, ready to begin, or in QA">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-success">{{ analytics.active_phases|length }}</h4>
                        <p class="fs-10 mb-0 text-muted">Active</p>
                        <small class="text-muted d-block">In progress</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-2">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Phases that are scheduled or planned but not yet started">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-info">{{ analytics.upcoming_phases|length }}</h4>
                        <p class="fs-10 mb-0 text-muted">Upcoming</p>
                        <small class="text-muted d-block">Scheduled</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-2">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Phases that have been completed and delivered to the client">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-secondary">{{ analytics.completed_phases|length }}</h4>
                        <p class="fs-10 mb-0 text-muted">Completed</p>
                        <small class="text-muted d-block">Delivered</small>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-3">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Total hours allocated across all phases for this service (delivery, reporting, management, QA, etc.)">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-warning">{{ analytics.total_allocated_hours }}</h4>
                        <p class="fs-10 mb-0 text-muted">Total Hours</p>
                        <small class="text-muted d-block">Allocated</small>
                      </div>
                    </div>
                  </div>

                  {% comment %} <div class="col-md-2">
                    <div class="card text-center" data-bs-toggle="tooltip"
                         title="Percentage of completed phases that were delivered on or before the desired delivery date">
                      <div class="card-body py-3">
                        <h4 class="mb-1 text-success">{{ analytics.on_time_rate }}%</h4>
                        <p class="fs-10 mb-0 text-muted">On Time Rate</p>
                        <small class="text-muted d-block">Delivery performance</small>
                      </div>
                    </div>
                  </div> {% endcomment %}
                </div>

                <!-- Client & Unit Breakdown -->
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Top Clients</h6>
                      </div>
                      <div class="card-body">
                        {% for client in analytics.client_breakdown|slice:":5" %}
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ client.job__client__name }}</span>
                            <div>
                              <span class="badge bg-primary-subtle text-primary me-2">{{ client.phase_count }} phases</span>
                              {% if client.total_hours %}
                                <span class="badge bg-info-subtle text-info">{{ client.total_hours }}h</span>
                              {% endif %}
                            </div>
                          </div>
                        {% empty %}
                          <p class="text-muted mb-0">No client data available</p>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Top Units</h6>
                      </div>
                      <div class="card-body">
                        {% for unit in analytics.unit_breakdown|slice:":5" %}
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ unit.job__unit__name }}</span>
                            <div>
                              <span class="badge bg-primary-subtle text-primary me-2">{{ unit.phase_count }} phases</span>
                              {% if unit.total_hours %}
                                <span class="badge bg-info-subtle text-info">{{ unit.total_hours }}h</span>
                              {% endif %}
                            </div>
                          </div>
                        {% empty %}
                          <p class="text-muted mb-0">No unit data available</p>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endwith %}

            <!-- Phase Status Tabs -->
            <div class="row mb-3">
              <div class="col-12">
                <ul class="nav nav-pills" id="phaseStatusTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="active-phases-tab" data-bs-toggle="pill"
                            data-bs-target="#active-phases" type="button" role="tab">
                      Active <span class="badge bg-success ms-1">{{ analytics.active_phases|length }}</span>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="upcoming-phases-tab" data-bs-toggle="pill"
                            data-bs-target="#upcoming-phases" type="button" role="tab">
                      Upcoming <span class="badge bg-info ms-1">{{ analytics.upcoming_phases|length }}</span>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-phases-tab" data-bs-toggle="pill"
                            data-bs-target="#completed-phases" type="button" role="tab">
                      Completed <span class="badge bg-secondary ms-1">{{ analytics.completed_phases|length }}</span>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-phases-tab" data-bs-toggle="pill"
                            data-bs-target="#all-phases" type="button" role="tab">
                      All <span class="badge bg-primary ms-1">{{ analytics.total_phases }}</span>
                    </button>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Phase Lists by Status -->
            <div class="tab-content" id="phaseStatusContent">
              <div class="tab-pane fade show active" id="active-phases" role="tabpanel">
                {% include 'partials/phase/phase_list_table.html' with phases=analytics.active_phases no_schedule_bar=1 %}
              </div>

              <div class="tab-pane fade" id="upcoming-phases" role="tabpanel">
                {% include 'partials/phase/phase_list_table.html' with phases=analytics.upcoming_phases no_schedule_bar=1 %}
              </div>

              <div class="tab-pane fade" id="completed-phases" role="tabpanel">
                {% include 'partials/phase/phase_list_table.html' with phases=analytics.completed_phases no_schedule_bar=1 %}
              </div>

              <div class="tab-pane fade" id="all-phases" role="tabpanel">
                {% get_phases_for_user request.user service.phases.all as all_phases %}
                {% include 'partials/phase/phase_list_table.html' with phases=all_phases no_schedule_bar=1 %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
  const { getColor, rgbaColor, getData } = window.phoenix.utils;
  var chartDom = document.getElementById('service-team-breakdown-chart');

  var chart = echarts.init(chartDom);
  options = {
    legend: {
        left: 'center',
        textStyle: {
        color: getColor('gray-600')
        }
    },
    series: [
        {
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['50%', '55%'],
        avoidLabelOverlap: false,
        label: {
            show: false,
            position: 'center'
        },
        labelLine: {
            show: false
        },
        data: [
            {
                value: {{ service.get_users_can_do_with_support | length }},
                name: 'Need Support',
                itemStyle: {
                    color: getColor('warning')
                }
            },
            {
                value: {{ service.get_users_can_do_alone | length }},
                name: 'Do Alone',
                itemStyle: {
                    color: getColor('success')
                }
            },
            {
                value: {{ service.get_users_specialist | length }},
                name: 'Specialist',
                itemStyle: {
                    color: getColor('primary')
                }
            },
        ]
        }
    ],
    tooltip: {
        trigger: 'item',
        padding: [7, 10],
        backgroundColor: getColor('gray-100'),
        borderColor: getColor('gray-300'),
        textStyle: { color: getColor('dark') },
        borderWidth: 1,
        transitionDuration: 0,
        axisPointer: {
            type: 'none'
        }
    }
  };
  options && chart.setOption(options);

  // Initialize Bootstrap tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Monthly Performance Trends Chart
  {% with metrics=service.get_performance_metrics %}
  var monthlyChartDom = document.getElementById('monthly-trends-chart');
  if (monthlyChartDom) {
    var monthlyChart = echarts.init(monthlyChartDom);

    var monthlyData = [
      {% for month_data in metrics.monthly_trends %}
        {
          month: '{{ month_data.month }}',
          phases: {{ month_data.phases_delivered }},
          onTimeRate: {{ month_data.on_time_rate }},
          totalHours: {{ month_data.total_hours }},
          avgHours: {{ month_data.avg_hours }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    var monthlyOptions = {
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          type: 'cross'
        }
      },
      legend: {
        data: ['Phases Delivered', 'On-Time Rate %', 'Total Hours'],
        left: 'center'
      },
      xAxis: {
        type: 'category',
        data: monthlyData.map(item => item.month.substring(0, 3))
      },
      yAxis: [
        {
          type: 'value',
          name: 'Count',
          position: 'left'
        },
        {
          type: 'value',
          name: 'Percentage',
          position: 'right',
          max: 100
        }
      ],
      series: [
        {
          name: 'Phases Delivered',
          type: 'bar',
          yAxisIndex: 0,
          data: monthlyData.map(item => item.phases),
          itemStyle: {
            color: getColor('primary')
          }
        },
        {
          name: 'On-Time Rate %',
          type: 'line',
          yAxisIndex: 1,
          data: monthlyData.map(item => item.onTimeRate),
          itemStyle: {
            color: getColor('success')
          }
        },
        {
          name: 'Total Hours',
          type: 'line',
          yAxisIndex: 0,
          data: monthlyData.map(item => item.totalHours),
          itemStyle: {
            color: getColor('warning')
          }
        }
      ]
    };

    monthlyChart.setOption(monthlyOptions);
  }
  {% endwith %}

</script>
{% endblock %}
