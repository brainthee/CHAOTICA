{% load crispy_forms_tags %}

<div class="card-header pb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Scoped Time</h4>

        <div class="form-check form-switch">
            <input class="form-check-input" id="scopeDaysChecked" type="checkbox" checked="" onchange="toggleScopeUnit()" />
            <label class="form-check-label" for="scopeDaysChecked">Show as Days</label>
        </div>
    </div>
    <div id="hours-per-day-setting" data-bs-toggle="tooltip" data-bs-placement="bottom" 
    title="Value set at the client level"
    class="justify-content-between align-items-center flex-column">
        <div class="alert alert-phoenix-info mb-0 px-3 py-1" role="alert">
            Hours per day: 
            <strong id="hours-per-day-display">8</strong>
            <span 
            class="far fs-10 fa-circle-question text-primary position-absolute ms-1 mt-1 top-0"></span>
        </div>
    </div>
</div>
<div class="card-body p-0">
  <table class="table table-striped table-sm mb-0">
    <thead>
      <tr>
        <th class="col-form-label ps-3">Type</th>
        <th class="col-form-label">Total <span id="unit-label">Days</span></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="ps-3 align-middle">Delivery</td>
        <td class="pt-3 pe-3 align-middle">{{ form.delivery_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">Reporting</td>
        <td class="pt-3 pe-3 align-middle">{{ form.reporting_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">Management</td>
        <td class="pt-3 pe-3 align-middle">{{ form.mgmt_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">QA</td>
        <td class="pt-3 pe-3 align-middle">{{ form.qa_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">Oversight</td>
        <td class="pt-3 pe-3 align-middle">{{ form.oversight_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">Debrief</td>
        <td class="pt-3 pe-3 align-middle">{{ form.debrief_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">Contingency</td>
        <td class="pt-3 pe-3 align-middle">{{ form.contingency_hours|as_crispy_field }}</td>
      </tr>
      <tr>
        <td class="ps-3 align-middle">Other</td>
        <td class="pt-3 pe-3 align-middle">{{ form.other_hours|as_crispy_field }}</td>
      </tr>
    </tbody>
  </table>
</div>
<div class="card-footer">
    <div class="d-flex justify-content-between align-items-center">
        <strong>Total:</strong>
        <div>
            <span id="total-display" class="fw-bold">0 Days</span>
            <span class="text-muted ms-2">(<span id="total-hours">0</span> hours)</span>
        </div>
    </div>
</div>

<!-- Hours per day value (controlled elsewhere in application) -->
<input type="hidden" id="hours_per_day" name="hours_per_day" value="{{ job.get_hours_in_day }}">

<script>
    let currentUnit = 'days';

    function getHoursPerDay() {
        return parseFloat(document.getElementById('hours_per_day').value) || 7.5;
    }

    function setHoursPerDay(hours) {
        document.getElementById('hours_per_day').value = hours;
        document.getElementById('hours-per-day-display').textContent = hours;
        updateConversions();
    }

    function updateTotals() {
        const inputs = document.querySelectorAll('.time-input');
        let total = 0;

        // Sum all current values
        inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });

        const hoursPerDay = getHoursPerDay();

        if (currentUnit === 'days') {
            // Currently in days mode
            const totalHours = total * hoursPerDay;
            document.getElementById('total-display').textContent = `${total.toFixed(2)} Days`;
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
        } else {
            // Currently in hours mode
            const totalDays = total / hoursPerDay;
            document.getElementById('total-display').textContent = `${totalDays.toFixed(1)} Days`;
            document.getElementById('total-hours').textContent = total.toFixed(1);
            // Update the parenthetical to show days instead
            document.querySelector('.text-muted .ms-2').innerHTML = `(<span id="total-days">${totalDays.toFixed(2)}</span> days)`;
        }

    }

    function toggleScopeUnit() {
        const useDays = document.getElementById('scopeDaysChecked').checked;
        const unit = useDays ? 'days' : 'hours';
        
        if (unit === currentUnit) return;
        
        const hoursPerDay = getHoursPerDay();
        
        // Convert all current values
        const inputs = document.querySelectorAll('.time-input');
        inputs.forEach(input => {
            const currentValue = parseFloat(input.value) || 0;
            if (currentValue > 0) {
                if (unit === 'days') {
                    // Convert hours to days using current hours per day setting
                    input.value = (currentValue / hoursPerDay).toFixed(3);
                } else {
                    // Convert days to hours using current hours per day setting
                    input.value = (currentValue * hoursPerDay).toFixed(1);
                }
            }
        });
        
        // Update UI
        currentUnit = unit;
        document.getElementById('unit-label').textContent = unit === 'hours' ? 'Hours' : 'Days';
        
        // Show/hide hours per day setting
        const hoursPerDayDiv = document.getElementById('hours-per-day-setting');
        if (unit === 'days') {
            hoursPerDayDiv.classList.remove('d-none');
        } else {
            hoursPerDayDiv.classList.add('d-none');
        }
        
        // Update input steps and field names
        inputs.forEach(input => {
            if (unit === 'days') {
                // Dynamic step based on hours per day (e.g., 1/8 for 8 hours, 1/7.5 for 7.5 hours)
                input.step = (1 / hoursPerDay).toFixed(4);
                input.name = input.name.replace('_hours', '_days');
            } else {
                input.step = '0.5'; // 0.5 hour increments
                input.name = input.name.replace('_days', '_hours');
            }
        });
        // Update totals after conversion
        updateTotals();
    }

    function updateConversions() {
        // If we're in days mode, re-convert all values with the new hours per day setting
        if (currentUnit === 'days') {
            // Temporarily switch to hours and back to days to trigger conversion with new rate
            currentUnit = 'hours';
            toggleUnit('days');
        }
        
        // Update step values for day inputs
        const hoursPerDay = getHoursPerDay();
        const inputs = document.querySelectorAll('.time-input');
        if (currentUnit === 'days') {
            inputs.forEach(input => {
                input.step = (1 / hoursPerDay).toFixed(4);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% comment %} document.getElementById('id_delivery_hours').value = '2';
        document.getElementById('id_reporting_hours').value = '1';
        document.getElementById('id_mgmt_hours').value = '1.5'; {% endcomment %}
        
        // Initialize the display with the current value
        document.getElementById('hours-per-day-display').textContent = getHoursPerDay();
        updateTotals();

    });
</script>