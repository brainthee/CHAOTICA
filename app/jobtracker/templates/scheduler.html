{% extends "base.html" %}
{% load menu %}{% load index %}
{% load crispy_forms_tags %}

{% block pageTitle %}Scheduler{% endblock pageTitle %}
{% block head_title %}Scheduler{% endblock head_title %}

{% block headerBlock_css %}mb-6{% endblock headerBlock_css %}
{% block content_classes %}px-0 {% endblock content_classes %}
{% block breadcrumb_classes %}px-5{% endblock breadcrumb_classes %}

{% block breadcrumbItem %}
<li class="breadcrumb-item active" aria-current="page">Scheduler</li>
{% endblock breadcrumbItem %}

{% block content %}
<div class="row px-5">
  <div class="col-12">
    <div class="row align-items-center justify-content-between g-3 mt-0 mb-0">
      <div class="col-6 col-md-auto">
        <h2 class="mb-2">
          Scheduler
        </h2>
        <p>
          The scheduler can be used to view the schedule and edit non-delivery timeslots. 
          For now; to edit delivery timeslots; use the scheduler within the job.
        </p>
      </div>

      <div class="col-md-auto">
        <div class="d-flex">
          <a href="#" class="btn btn-outline-secondary ms-auto">
            Export
          </a>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row g-0 mt-3 border-1 border-top bg-light dark__bg-1100 h-100">
  <div class="col-9 bg-white min-vh-100 border-1 border-end">

    <div class="card-calendar min-vh-100">
      <div class="card-body p-0">
        <div class="calendar" data-bs-toggle="calendar" id="calendar"></div>
      </div>
    </div>

  </div>

  <div class="col-3 px-0 border-start-xxl border-300 border-top-0">
    <div class="h-100">
      <div class="bg-light dark__bg-1100 h-100 p-3">
        <div class="scrollbar" id="productFilterColumn">
          <div class="row mb-3">
            {% csrf_token %}
            {% crispy filterForm %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}


{% block footer_javascript_page %}
<script>

var calendarEl = document.getElementById('calendar');
var csrf = $('input[name="csrfmiddlewaretoken"]');

const urlParams = new URLSearchParams(window.location.search).entries();

var urlSearchParams = {}
for(const entry of urlParams) {
  urlSearchParams[entry[0]] = entry[1];
}
// var scrollTime = moment().format("YYYY-MM-DD");

var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'resourceTimelineMonth',
    themeSystem: 'bootstrap5',
    headerToolbar: {
        left: 'today prev,next',
        center: 'title',
        right: 'resourceTimelineTenDay,resourceTimelineMonth,resourceTimelineYear'
    },
    // {% py_date_to_js_date request.GET.from_date as from_date %}
    // {% if from_date %}
    initialDate: '{{ from_date }}',
    // {% endif %}
    views: {
        resourceTimelineTenDay: {
            type: 'resourceTimeline',
            duration: { days: 10 },
            buttonText: '10 days'
        }
    },
    displayEventTime: false,
    refetchResourcesOnNavigate: true,
    resourceAreaHeaderContent: 'Users',
    resources: {
        url: "{% url 'view_scheduler_members' %}",
        method: 'GET',
        extraParams: urlSearchParams,
        failure: function() {
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Something went wrong getting scheduler members!',
          })
        },
    },
    eventSources: [
      //   {
      //     url: "{% url 'view_scheduler_slots' %}",
      //     method: 'GET',
      //     extraParams: urlSearchParams,
      //     failure: function() {
      //       Swal.fire({
      //         icon: 'error',
      //         title: 'Oops...',
      //         text: 'Something went wrong getting scheduler events!',
      //       })
      //     },
      // }
        function(info, successCallback, failureCallback) {
          // lets get members
          superagent.get("{% url 'view_scheduler_slots' %}")
            .type('json')
            .query({
              start: info.start.toJSON(),
              end: info.end.toJSON()
            })
            .end(function(err, res) {

              if (err) {
                failureCallback(err);
              } else {
                successCallback(res.body)
              }
            })
        },
    ],
    eventClick: function(info) {
      info.jsEvent.preventDefault(); // don't let the browser navigate
      // Show slot edit modal
      $.ajax({
          url: '{% url "change_scheduler_slot" %}'+info.event.id,
          type: 'get',
          dataType: 'json',
          success: function(data) {
              $("#mainModalContent").html(data.html_form);
              $("#mainModal").modal("show");
          }
      });
    },
    selectable: true,
    editable: true,
    droppable: true,
    nowIndicator: true,
    timeZone: '{{ user.pref_timezone }}', // the default (unnecessary to specify)
    select: function(info) {
      // get the selection info
      // https://swisnl.github.io/jQuery-contextMenu/
      $.contextMenu({
        selector: '.fc-scroller', 
        trigger: 'none',
        build: function($triggerElement, e){
          return {
            callback: function(key, options) {
      
                start_date = info.start.toJSON();
                end_date = info.end.toJSON();
                resource_id = info.resource.id;
                // Lets open a modal window to setup the   
                switch(key) {
                  case "assign_phase":
                    $.ajax({
                      url: '{% url "create_scheduler_phase_slot" %}?resource_id='+parseInt(resource_id)+'&start='+start_date+'&end='+end_date,
                      type: 'get',
                      dataType: 'json',
                      success: function(data) {
                          $("#mainModalContent").html(data.html_form);
                          $("#mainModal").modal("show");
                      }
                    });
                    break;
                  case "assign_internal":
                    $.ajax({
                      url: '{% url "create_scheduler_internal_slot" %}?resource_id='+parseInt(resource_id)+'&start='+start_date+'&end='+end_date,
                      type: 'get',
                      dataType: 'json',
                      success: function(data) {
                          $("#mainModalContent").html(data.html_form);
                          $("#mainModal").modal("show");
                      }
                    });
                    break;
                  case "add_comment":
                    $.ajax({
                      url: '{% url "create_scheduler_comment" %}?resource_id='+parseInt(resource_id)+'&start='+start_date+'&end='+end_date,
                      type: 'get',
                      dataType: 'json',
                      success: function(data) {
                          $("#mainModalContent").html(data.html_form);
                          $("#mainModal").modal("show");
                      }
                    });
                    break;
                  case "clear":
                    $.ajax({
                      url: '{% url "clear_scheduler_range" %}?resource_id='+parseInt(resource_id)+'&start='+start_date+'&end='+end_date,
                      type: 'get',
                      dataType: 'json',
                      success: function(data) {
                          $("#mainModalContent").html(data.html_form);
                          $("#mainModal").modal("show");
                      }
                    });
                    break;
                } 
                // Swal.fire({
                //   title: "clicked: " + key,
                //   icon: "success",
                // });
                // Destroy the menu so we have a fresh one next time
                $('.fc-scroller').contextMenu('destroy');
            },
            position: function(opt, x, y){
                opt.$menu.css({top: info.jsEvent.y, left: info.jsEvent.x});
            },
            items: {
                "assign_phase": {name: "Assign phase", icon: "fas fa-cubes fs-0 me-2"},
                "assign_internal": {name: "Assign internal", icon: "fas fa-cubes fs-0 me-2"},
                // "assign_task": {name: "Assign task", icon: "fas fa-checkboard fs-0 me-2"},
                "add_comment": {name: "Add Comment", icon: "fas fa-comment fs-0 me-2"},
                "clear": {name: "Clear Range", icon: "fas fa-wipe fs-0 me-2"},
            }
          };
        }
      });
      $('.fc-scroller').contextMenu();
    },
    eventDrop: function(info) {
      Swal.fire({
        title: 'Do you want to save the changes?',
        showCancelButton: true,
        confirmButtonText: 'Save',
      }).then((result) => {
        if (result.isConfirmed) {
          // Save the change...
          var slotData = {
              "pk": info.event.id,
              "start": info.event.start.toJSON(),
              "end": info.event.end.toJSON(),
              "user": info.event.extendedProps.userId,
              "csrfmiddlewaretoken": csrf.val(),
            };
          if (info.newResource) {
            slotData['user'] = info.newResource.id;
          };
          $.ajax({
            url: '{% url "change_scheduler_slot_date" %}'+info.event.id,
            data: slotData,
            type: "POST",
            dataType: 'json',
            success: function(data) {
              if (!data.form_is_valid) {
                Swal.fire(
                  'Failed to modify',
                  'Something went wrong. Please check the data entered.',
                  'warning'
                );    
                info.revert();
              } else {
                calendar.refetchEvents();
              }
            }
          });
        } else {
          info.revert();
        }
      });
    },
    eventResize: function(info) {
      Swal.fire({
        title: 'Do you want to save the changes?',
        showCancelButton: true,
        confirmButtonText: 'Save',
      }).then((result) => {
        if (result.isConfirmed) {          
          // Save the change...
          var slotData = {
              "pk": info.event.id,
              "start": info.event.start.toJSON(),
              "end": info.event.end.toJSON(),
              "user": info.event.extendedProps.userId,
              "csrfmiddlewaretoken": csrf.val(),
            };
          $.ajax({
            url: '{% url "change_scheduler_slot_date" %}'+info.event.id,
            data: slotData,
            type: "POST",
            dataType: 'json',
            success: function(data) {
              if (!data.form_is_valid) {
                Swal.fire(
                  'Failed to modify',
                  'Something went wrong. Please check the data entered.',
                  'warning'
                );    
                info.revert();
              } else {
                location.reload();
              }
            }
          });
        } else {
          info.revert();
        }
      });
    },
  });

calendar.render();

</script>
{% endblock footer_javascript_page %}