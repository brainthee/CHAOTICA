{% extends "base.html" %}
{% load menu %}{% load index %}
{% load crispy_forms_tags %}

{% block pageTitle %}Scheduler{% endblock pageTitle %}
{% block head_title %}Scheduler{% endblock head_title %}

{% block headerBlock_css %}mb-6{% endblock headerBlock_css %}
{% block content_classes %}px-0 {% endblock content_classes %}
{% block breadcrumb_classes %}px-5{% endblock breadcrumb_classes %}

{% block breadcrumbItem %}
<li class="breadcrumb-item active" aria-current="page">Scheduler</li>
{% endblock breadcrumbItem %}

{% block content %}
<div class="row px-5">
  <div class="col-12">
    <div class="row align-items-center justify-content-between g-3 mt-0 mb-0">
      <div class="col-6 col-md-auto">
        <h2 class="mb-2">
          Scheduler
        </h2>
      </div>

      <div class="col-md-auto">
        <div class="d-flex">
          <a href="#" class="btn btn-outline-secondary ms-auto">
            Export
          </a>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row g-0 mt-3 border-1 border-top bg-light dark__bg-1100 h-100">
  <div class="col-9 bg-white min-vh-100 border-1 border-end">

    <div class="card-calendar min-vh-100">
      <div class="card-body p-0">
        <div class="calendar" data-bs-toggle="calendar" id="calendar"></div>
      </div>
    </div>

  </div>

  <div class="col-3 px-0 border-start-xxl border-300 border-top-0">
    <div class="h-100">
      <div class="bg-light dark__bg-1100 h-100 p-3">
        <div class="scrollbar" id="productFilterColumn">
          <div class="row mb-3">
            <h4>Filtering</h4>
            {% crispy filterForm %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}


{% block footer_javascript_page %}
<script>

var calendarEl = document.getElementById('calendar');

const urlParams = new URLSearchParams(window.location.search).entries();

var urlSearchParams = {}
for(const entry of urlParams) {
  urlSearchParams[entry[0]] = entry[1];
}

var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'resourceTimelineMonth',
    themeSystem: 'bootstrap5',
    headerToolbar: {
        left: 'today prev,next',
        center: 'title',
        right: 'resourceTimelineTenDay,resourceTimelineMonth,resourceTimelineYear'
    },
    scrollTime: '08:00',
    {% py_date_to_js_date request.GET.from_date as from_date %}
    {% if from_date %}
    initialDate: '{{ from_date }}',
    {% endif %}
    views: {
        resourceTimelineTenDay: {
            type: 'resourceTimeline',
            duration: { days: 10 },
            buttonText: '10 days'
        }
    },
    displayEventTime: false,
    resourceAreaHeaderContent: 'Users',
    resources: {
        url: "{% url 'view_scheduler_members' %}",
        method: 'GET',
        extraParams: urlSearchParams,
        failure: function() {
          alert('there was an error while fetching resources!');
        },
    },
    events: {
        url: "{% url 'view_scheduler_slots' %}",
        method: 'GET',
        extraParams: urlSearchParams,
        failure: function() {
          alert('there was an error while fetching events!');
        },
    },
    eventClick: function(info) {
      info.jsEvent.preventDefault(); // don't let the browser navigate
      // Show slot edit modal
      if (info.event.url) {
        $.ajax({
            url: info.event.url,
            type: 'get',
            dataType: 'json',
            success: function(data) {
                $("#mainModalContent").html(data.html_form);
                $("#mainModal").modal("show");
            }
        });
      }
    },
    selectable: true,
    select: function(info) {
      // get the selection info
      start_date = info.start.toJSON();
      end_date = info.end.toJSON();
      resource_id = info.resource.id;
      // Lets open a modal window to setup the    

      $.ajax({
          url: '{% url "create_scheduler_slot" %}?resource_id='+parseInt(resource_id)+'&start='+start_date+'&end='+end_date,
          type: 'get',
          dataType: 'json',
          success: function(data) {
              $("#mainModalContent").html(data.html_form);
              $("#mainModal").modal("show");
          }
        });
    },
    editable: true,
    droppable: false,
    nowIndicator: true,
  });

calendar.render();
</script>
{% endblock footer_javascript_page %}